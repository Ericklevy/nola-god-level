version: '3.8'

services:
  # --- 1. STACK DE DADOS (Base do Desafio) ---
  postgres:
    image: postgres:15
    container_name: nola-db
    environment:
      POSTGRES_DB: challenge_db
      POSTGRES_USER: challenge
      POSTGRES_PASSWORD: challenge_2024
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/database-schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U challenge -d challenge_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  data-generator:
    build:
      context: ./scripts
    container_name: nola-data-gen
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://challenge:challenge_2024@postgres:5432/challenge_db
    command: >
      sh -c "
        echo 'Waiting for database...' && sleep 5 &&
        echo 'Generating challenge data...' &&
        python generate_data.py --db-url postgresql://challenge:challenge_2024@postgres:5432/challenge_db
      "
    profiles:
      - tools # Só roda se chamado explicitamente: docker compose run --rm data-generator

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: nola-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@godlevel.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      - postgres
    profiles:
      - tools

  # --- 2. SUA STACK DE APLICAÇÃO ---
  elasticsearch:
    image: elasticsearch:8.10.4 # Use uma versão específica
    container_name: nola-elastic
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m" # Limita memória para dev
      - xpack.security.enabled=false # Desabilita segurança para dev
    ports:
      - "9200:9200"
    volumes:
      - elastic_data:/usr/share/elasticsearch/data

  kibana:
    image: kibana:8.10.4
    container_name: nola-kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    profiles:
      - tools # Opcional, mas útil para debug

  backend-api:
    build:
      context: ./backend
    container_name: nola-backend-api
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    environment:
      DATABASE_URL: "postgresql://challenge:challenge_2024@postgres:5432/challenge_db"
      ELASTIC_URL: "http://elasticsearch:9200"
    depends_on:
      postgres:
        condition: service_healthy
      elasticsearch:
        condition: service_started

  ai-service:
    build:
      context: ./services/ai_service
    container_name: nola-ai-service
    ports:
      - "8001:8000"
    volumes:
      - ./services/ai_service/app:/app # Hot reload
    env_file:
      - .env # Puxa a GEMINI_API_KEY
    depends_on:
      - backend-api

  frontend-react:
    build:
      context: ./frontend
    container_name: nola-frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/src:/app/src # Hot reload
      - ./frontend/public:/app/public
    environment:
      - CHOKIDAR_USEPOLLING=true # Necessário para hot-reload em Docker
    depends_on:
      - backend-api
  
  # --- 3. SERVIÇO DE TESTE (NOVO) ---
  test-runner:
    build:
      context: ./tests
    container_name: nola-test-runner
    depends_on:
      backend-api:
        condition: service_started # Espera a API iniciar
    environment:
      # Passa a URL interna da API para os scripts de teste
      - API_URL=http://backend-api:8000
    command: pytest -v --disable-warnings
    profiles:
      - testing # Só roda quando você pedir


volumes:
  postgres_data:
  elastic_data: